<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Manuscript Ledger</title>

<style>
:root{
  --bg:#F5F7F8;
  --paper:#ffffff;
  --paper2:#eef2f4;
  --accent:#73A8B8;
  --deep:#5E8F9E;
  --ink:#2E2E2E;
  --muted:#6c7a80;
  --border:#dde5e8;
  --shadow:0 18px 40px rgba(0,0,0,.06);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Georgia, serif;
  background:var(--bg);
  color:var(--ink);
}

/* HERO */
.hero{
  padding:90px 20px;
  background:linear-gradient(var(--paper),var(--paper2));
}
.hero-inner{
  max-width:1100px;
  margin:auto;
  display:flex;
  gap:70px;
  align-items:center;
}
.hero-portrait img{
  width:240px;
  border-radius:6px;
  box-shadow:0 15px 40px rgba(0,0,0,.08);
}
.hero-text h1{font-size:42px;margin:0 0 8px; letter-spacing:.5px}
.hero-text h2{font-weight:normal;color:var(--muted);margin:0 0 25px}
.hero-manifesto{font-size:18px;line-height:1.6;margin-bottom:30px}

button{
  background:var(--accent);
  color:white;
  border:none;
  padding:10px 16px;
  border-radius:5px;
  cursor:pointer;
  transition:transform .12s ease, background .15s ease;
}
button:hover{background:var(--deep)}
button:active{transform:translateY(1px)}
.btn-quiet{
  background:#dfe8eb;
  color:var(--ink);
}
.btn-quiet:hover{background:#d0dde2}
.btn-danger{
  background:#b85d5d;
}
.btn-danger:hover{background:#a24e4e}
.btn-mini{
  padding:8px 10px;
  font-size:13px;
  border-radius:6px;
}
.icon-btn{
  width:36px;height:36px;
  display:inline-grid;place-items:center;
  padding:0;
  border-radius:8px;
}

input, select, textarea{
  font:inherit;
  color:var(--ink);
}

/* MANUSCRIPT BLOCK */
.section{padding:70px 20px}
.section-inner{max-width:1100px;margin:auto}

.manuscript-block{text-align:center}
.manuscript-title{
  font-size:13px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--muted);
}
.manuscript-total{
  font-size:36px;
  font-weight:600;
  margin:10px 0 40px;
}

/* CIRCLES */
.cars-container{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:32px;
}
.car{text-align:center;opacity:.65;cursor:pointer; transition:transform .18s ease, opacity .18s ease}
.car.active{opacity:1;transform:scale(1.05)}
.percent-text{
  font-size:14px;
  font-weight:600;
  fill:var(--ink);
}
.stage-label{
  display:block;
  font-size:13px;
  font-style:italic;
  color:var(--muted);
  margin-top:4px;
}

/* NEW: GOALS + ACTIVITY */
.project-shell{
  margin-top:55px;
  background:linear-gradient(#ffffff,#f3f6f7);
  padding:22px;
  border-radius:10px;
  box-shadow:var(--shadow);
  text-align:left;
}
.project-title{
  text-align:center;
  font-size:13px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:18px;
}
.project-grid{
  display:grid;
  grid-template-columns: 1.05fr .95fr;
  gap:18px;
  align-items:start;
}
.panel{
  background:rgba(255,255,255,.9);
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
}
.panel-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 14px 12px;
  border-bottom:1px solid var(--border);
  background:linear-gradient(#ffffff, #f7fafb);
}
.panel-head .heading{
  font-size:12px;
  letter-spacing:1.6px;
  text-transform:uppercase;
  color:var(--muted);
}
.panel-body{padding:14px}

.tabs{
  display:flex;
  gap:8px;
  align-items:center;
}
.tab{
  border:1px solid var(--border);
  background:#fff;
  color:var(--ink);
  padding:8px 10px;
  border-radius:999px;
  cursor:pointer;
  font-size:13px;
  transition:background .15s ease, transform .12s ease, border-color .15s ease;
}
.tab:hover{transform:translateY(-1px)}
.tab[aria-selected="true"]{
  background:rgba(115,168,184,.18);
  border-color:rgba(115,168,184,.55);
}

.row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.field{
  display:flex;
  flex-direction:column;
  gap:6px;
  flex:1 1 180px;
  min-width:180px;
}
.field label{
  font-size:12px;
  letter-spacing:1px;
  text-transform:uppercase;
  color:var(--muted);
}
.field input, .field select, .field textarea{
  width:100%;
  padding:10px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#fff;
  outline:none;
}
.field textarea{min-height:90px; resize:vertical}

.hr{
  height:1px;
  background:var(--border);
  margin:14px 0;
}

/* goals list */
.list{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.goal-item{
  display:grid;
  grid-template-columns: 40px 1fr auto;
  gap:10px;
  align-items:center;
  padding:10px 10px;
  border:1px solid var(--border);
  border-radius:12px;
  background:#fff;
}
.goal-toggle{
  width:36px;height:36px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#f7fafb;
  cursor:pointer;
  display:grid;
  place-items:center;
  transition:transform .12s ease, background .15s ease, border-color .15s ease;
}
.goal-toggle:hover{transform:translateY(-1px)}
.goal-toggle[aria-pressed="true"]{
  background:rgba(115,168,184,.22);
  border-color:rgba(115,168,184,.65);
}
.goal-meta .name{
  font-weight:700;
  letter-spacing:.2px;
}
.goal-meta .sub{
  margin-top:2px;
  color:var(--muted);
  font-size:13px;
  line-height:1.2;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fbfdfe;
  color:var(--muted);
  font-size:12px;
  letter-spacing:1px;
  text-transform:uppercase;
  white-space:nowrap;
}
.goal-actions{
  display:flex;
  gap:8px;
  align-items:center;
}
.small-link{
  border:none;
  background:transparent;
  color:var(--deep);
  cursor:pointer;
  padding:6px 6px;
  border-radius:8px;
}
.small-link:hover{background:rgba(115,168,184,.12)}

/* Activity log */
.log{
  display:flex;
  flex-direction:column;
  gap:10px;
  max-height:520px;
  overflow:auto;
  padding-right:6px;
}
.log::-webkit-scrollbar{width:10px}
.log::-webkit-scrollbar-thumb{background:#d9e3e7; border-radius:999px; border:2px solid transparent; background-clip:padding-box}

.log-entry{
  border:1px solid var(--border);
  border-radius:12px;
  background:#fff;
  padding:10px 10px;
}
.log-entry .top{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
}
.log-entry .type{
  font-size:12px;
  letter-spacing:1.2px;
  text-transform:uppercase;
  color:var(--muted);
}
.log-entry time{
  color:var(--muted);
  font-size:12px;
  white-space:nowrap;
}
.log-entry .text{
  margin-top:6px;
  line-height:1.45;
}
.log-entry .controls{
  margin-top:8px;
  display:flex;
  gap:10px;
}
.log-entry .controls button{
  padding:7px 10px;
  font-size:13px;
}

/* ANALYTICS */
.analytics-shell{
  margin-top:18px;
  background:linear-gradient(#ffffff,#f3f6f7);
  padding:25px;
  border-radius:10px;
  box-shadow:var(--shadow);
}
.analytics-title{
  text-align:center;
  font-size:13px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:20px;
}
.analytics-grid{
  display:grid;
  gap:18px;
  align-items:stretch;
  grid-template-columns:repeat(12, 1fr);
}
.kpi{
  background:white;
  padding:15px;
  border-radius:10px;
  text-align:left;
  display:flex;
  flex-direction:column;
  min-height:0;
}
.kpi .label{
  font-size:12px;
  letter-spacing:1px;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:8px;
}
.kpi .value{
  font-size:20px;
  font-weight:700;
}
.kpi--rect{grid-column:span 6; aspect-ratio:16/9;}
.kpi--square{grid-column:span 4; aspect-ratio:1/1; justify-content:space-between;}
.chart-wrapper{
  display:flex;
  height:100%;
  gap:10px;
  position:relative;
}

.chart-yaxis{
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  font-size:11px;
  color:var(--muted);
  text-align:right;
  padding-right:6px;
  min-width:38px;
}

.chart-area{
  flex:1;
  position:relative;
  display:flex;
  flex-direction:column;
}

.chart-grid{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  pointer-events:none;
}

.chart-grid div{
  border-top:1px solid rgba(115,168,184,.12);
}

.chart{
  display:grid;
  align-items:end;
  height:100%;
  min-height:110px;
  position:relative;
  z-index:1;
}

.chart-xaxis{
  display:grid;
  font-size:10px;
  color:var(--muted);
  margin-top:6px;
}
.bar{
  background:var(--accent);
  border-radius:3px 3px 0 0;
  opacity:.8;
  transition:filter .15s ease, transform .12s ease;
}
.bar:hover{
  filter:brightness(1.06);
}
.bar.over-cap{
  background:#ae9a64;
}

/* MODALS */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
}
.modal-content{
  background:white;
  padding:18px;
  border-radius:12px;
  width:min(520px, 100%);
  box-shadow:0 30px 80px rgba(0,0,0,.20);
}
.modal-content h3{margin:0 0 12px}
.modal-content input,
.modal-content select,
.modal-content textarea{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
  border:1px solid var(--border);
}
.modal-footer{display:flex;gap:10px; margin-top:6px}
.modal-footer button{flex:1}
.cancel{background:#aaa}
.cancel:hover{background:#8f8f8f}

@media (max-width: 980px){
  .hero-inner{flex-direction:column; text-align:center}
  .project-grid{grid-template-columns:1fr}
  .kpi--rect{grid-column:span 12; aspect-ratio:21/9;}
  .kpi--square{grid-column:span 6;}
}
@media (max-width: 520px){
  .kpi--square{grid-column:span 12; aspect-ratio:auto;}
}

/* ===== Google Sites additions (minimal) ===== */
.author-only { display: none !important; }
body.edit-mode .author-only { display: inline-block !important; }
body.edit-mode .panel-head button.author-only { display: block !important; }

/* Author controls layout (keeps your look intact) */
.author-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.reset-wrap{display:flex;gap:10px;align-items:center}
button:disabled{opacity:.55;cursor:not-allowed;filter:saturate(.6)}

/* Tiny toggle switch */
.switch{position:relative;display:inline-block;width:40px;height:22px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#dfe8eb;transition:.18s;border-radius:999px;border:1px solid var(--border)}
.slider:before{position:absolute;content:"";height:16px;width:16px;left:3px;bottom:2px;background:white;transition:.18s;border-radius:999px;box-shadow:0 4px 10px rgba(0,0,0,.10)}
.switch input:checked + .slider{background:rgba(184,93,93,.28);border-color:rgba(184,93,93,.45)}
.switch input:checked + .slider:before{transform:translateX(18px)}
</style>
</head>

<body>

<header class="hero">
  <div class="hero-inner">
    <div class="hero-portrait">
      <img src="https://images.gr-assets.com/photos/1680281128p8/4220610.jpg" alt="Portrait of Cayddrick Harris Ballard">
    </div>
    <div class="hero-text">
      <h1>THE MANUSCRIPT LEDGER</h1>
      <h2>A Record of Ink, Effort, and Endurance.</h2>
      <p class="hero-manifesto">
        This is where I keep faith with the work.<br>
        Word by word. Chapter by chapter.<br>
        No shortcuts. No vanishing drafts.
      </p>
      <div class="author-controls">
        <button class="author-only" onclick="openModal()">Author’s Update</button>
        <div class="author-only reset-wrap" aria-label="Reset controls">
          <label class="switch" title="Arm reset (testing)">
            <input type="checkbox" id="resetToggle" onchange="document.getElementById('resetBtn').disabled = !this.checked;">
            <span class="slider"></span>
          </label>
          <button class="btn-mini btn-danger" id="resetBtn" onclick="resetEverything()" disabled>Reset</button>
        </div>
      </div>
    </div>
  </div>
</header>

<section class="section manuscript-block">
  <div class="section-inner">
    <div class="manuscript-title">MANUSCRIPT ACCUMULATIVE</div>
    <div class="manuscript-total"><span id="totalWords">0</span> words written</div>

    <div class="cars-container" id="carsContainer"></div>

    <!-- NEW: GOALS + PROCRASTINATION + ACTIVITY LOG (between circles and analytics) -->
    <div class="project-shell" aria-label="Project workspace">
      <div class="project-title">PROJECT WORKSPACE</div>

      <div class="project-grid">
        <!-- LEFT: tabs -->
        <section class="panel" aria-label="Goals and Procrastination Station">
          <div class="panel-head">
            <div class="tabs" role="tablist" aria-label="Workspace tabs">
              <button class="tab" id="tabGoals" role="tab" aria-selected="true" aria-controls="panelGoals" onclick="switchWorkspaceTab('goals')">Project Goals</button>
              <button class="tab" id="tabPro" role="tab" aria-selected="false" aria-controls="panelPro" onclick="switchWorkspaceTab('pro')">Procrastination Station</button>
            </div>

            <div class="row" style="justify-content:flex-end">
              <button class="btn-mini author-only" id="primaryActionBtn" onclick="openGoalModal()">+ Add New</button>
            </div>
          </div>

          <div class="panel-body">
            <!-- Goals tab -->
            <div id="panelGoals" role="tabpanel" aria-labelledby="tabGoals">
              <div class="row" style="justify-content:space-between; align-items:flex-end">
                <div class="field" style="max-width:260px">
                  <label for="goalFilter">Goals view</label>
                  <select id="goalFilter" onchange="renderGoals()">
                    <option value="all">Show all goals</option>
                    <option value="active">Show only active goal</option>
                  </select>
                </div>

                <div class="pill" id="activeGoalPill">Active: —</div>
              </div>

              <div class="hr"></div>

              <div class="list" id="goalsList" aria-label="Goals list"></div>
              <div id="goalsEmpty" style="display:none; color:var(--muted); font-style:italic; padding:8px 2px;">
                No goals yet. Add one to begin.
              </div>
            </div>

            <!-- Procrastination Station tab -->
            <div id="panelPro" role="tabpanel" aria-labelledby="tabPro" hidden>
              <p style="margin:0 0 12px; color:var(--muted); font-style:italic;">
                Saved links and notes appear here.
              </p>

              <div class="list" id="proList" aria-label="Saved procrastination items"></div>
              <div id="proEmpty" style="display:none; color:var(--muted); font-style:italic; padding:8px 2px;">
                Nothing saved yet. Add a link or note when inspiration strikes.
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT: activity log -->
        <aside class="panel" aria-label="Activity log">
          <div class="panel-head">
            <div class="heading">Activity Log</div>
            <button class="btn-mini author-only" onclick="openNoteModal()">+ Note</button>
          </div>

          <div class="panel-body">
            <div class="log" id="activityLog" aria-label="Activity entries"></div>
            <div id="activityEmpty" style="display:none; color:var(--muted); font-style:italic; padding:8px 2px;">
              No activity yet. Updates will appear here.
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- ANALYTICS -->
    <div class="analytics-shell">
      <div class="analytics-title">WRITING ANALYTICS</div>
      <div class="analytics-grid">

        <div class="kpi kpi--rect">
          <div class="label">Hourly Writing Pattern</div>
          <div class="chart-wrapper">
            <div id="hourlyYAxis" class="chart-yaxis"></div>
            <div class="chart-area">
              <div id="hourlyGrid" class="chart-grid"></div>
              <div id="hourlyChart" class="chart"></div>
              <div id="hourlyXAxis" class="chart-xaxis"></div>
             </div>
            </div>
          <div class="value" id="animalIndicator">—</div>
        </div>

        <div class="kpi kpi--rect">
          <div class="label">Daily Word Count (This Month)</div>
          <div class="chart-wrapper">
            <div id="dailyYAxis" class="chart-yaxis"></div>
            <div class="chart-area">
              <div id="dailyGrid" class="chart-grid"></div>
              <div id="dailyChart" class="chart"></div>
              <div id="dailyXAxis" class="chart-xaxis"></div>
            </div>
          </div>    
        </div>
          

        <div class="kpi kpi--square">
          <div class="label">Average / Session</div>
          <div class="value"><span id="avgSession">0</span> words</div>
        </div>

        <div class="kpi kpi--square">
          <div class="label">Top Location</div>
          <div class="value" id="topLocation">—</div>
        </div>

        <div class="kpi kpi--square">
          <div class="label">When I'll Finish</div>
          <div class="value" id="finishEstimate">—</div>
        </div>

      </div>
    </div>

  </div>
</section>

<!-- EXISTING MODAL: writing session -->
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Author update dialog">
  <div class="modal-content">
    <h3>Author’s Update</h3>

    <select id="realmInput"></select>
    <select id="stageInput">
      <option>Outline</option>
      <option>Draft</option>
      <option>Revision</option>
      <option>Finalizing</option>
      <option>Editing</option>
    </select>
    <input type="number" id="stageNumberInput" placeholder="Stage Number">
    <input type="number" id="wordsInput" placeholder="Words this session">
    <select id="locationInput">
      <option>Home</option>
      <option>Cafe</option>
      <option>Library</option>
      <option>Office</option>
      <option>Travel</option>
    </select>
    <div class="modal-footer">
      <button onclick="submitSession()">Update</button>
      <button class="cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- NEW MODAL: add/edit goal -->
<div class="modal" id="goalModal" role="dialog" aria-modal="true" aria-label="Goal editor">
  <div class="modal-content">
    <h3 id="goalModalTitle">New Goal</h3>

    <div class="row">
      <div class="field">
        <label for="goalName">Goal name</label>
        <input id="goalName" placeholder="Write 2,500 words / Revise Act II / etc.">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="goalType">Goal type</label>
        <select id="goalType" onchange="syncGoalTypeUI()">
          <option value="words">Word Count</option>
          <option value="date">Date / Event</option>
        </select>
      </div>

      <div class="field" id="goalWordsField">
        <label for="goalTargetWords">Target words</label>
        <input id="goalTargetWords" type="number" min="1" placeholder="2500">
      </div>

      <div class="field" id="goalDateField" style="display:none">
        <label for="goalTargetDate">Target date</label>
        <input id="goalTargetDate" type="date">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="goalNotes">Notes (optional)</label>
        <textarea id="goalNotes" placeholder="Why this goal matters, constraints, plan..."></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" id="goalSaveBtn">Save</button>
      <button class="cancel" onclick="closeGoalModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- NEW MODAL: manual note (editable + deletable) -->
<div class="modal" id="noteModal" role="dialog" aria-modal="true" aria-label="Add a note">
  <div class="modal-content">
    <h3 id="noteModalTitle">New Note</h3>
    <textarea id="noteText" placeholder="A short thought, a mood, something I learned today..." style="min-height:130px"></textarea>
    <div class="modal-footer">
      <button onclick="saveManualNote()">Save</button>
      <button class="cancel" onclick="closeNoteModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- NEW MODAL: add procrastination link/note -->
<div class="modal" id="proModal" role="dialog" aria-modal="true" aria-label="Add procrastination item">
  <div class="modal-content">
    <h3>Add Link / Note</h3>

    <div class="row">
      <div class="field">
        <label for="proTitle">Title</label>
        <input id="proTitle" placeholder="Playlist for Chapter 7, article on pacing, etc.">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="proUrl">Link (optional)</label>
        <input id="proUrl" placeholder="https://...">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="proNote">Note</label>
        <textarea id="proNote" placeholder="Why this matters / where I found it / what it sparked..."></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button onclick="saveProcrastinationItem()">Save</button>
      <button class="cancel" onclick="closeProModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Google Sites Cloud Sync (minimal)
   - Public: loads from cloud
   - Author: add ?mode=edit to show buttons + allow POST saves
========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzGvaB1O9HNOqFkoRv2B8GVuDfaR2c_pZRX_55N9Q6hJmzy2BVxQmdQEem9WdC2VLdimA/exec";

const params = new URLSearchParams(window.location.search);
let mode = params.get('mode');

// Google Sites often embeds this in an iframe, so the querystring may live on the parent URL.
// document.referrer usually contains the full Sites page URL (including ?mode=edit).
if (!mode && document.referrer) {
  try { mode = new URL(document.referrer).searchParams.get('mode'); } catch (e) {}
}

if (mode === 'edit') {
  document.body.classList.add('edit-mode');
}

let hasLocalMutations = false;

function isEditMode(){
  return document.body.classList.contains('edit-mode');
}

function hasLocalSnapshot(){
  return !!localStorage.getItem(LS_KEY);
}

async function loadFromCloud() {
  try {
    const response = await fetch(
      SCRIPT_URL + "?t=" + Date.now(),  // ← forces fresh request
      {
        method: "GET",
        cache: "no-store"
      }
    );

    const data = await response.json();
    console.log("[Cloud Load] Fresh fetch", data);

    if (data && typeof data === "object") {
      state = data.state || state;
      sessions = data.sessions || [];
      selectedIndex = data.selectedIndex || 0;
      goals = data.goals || [];
      proItems = data.proItems || [];
      activity = data.activity || [];
      workspaceTab = data.workspaceTab || "goals";
    }

  } catch (e) {
    console.log("Cloud load failed:", e);
  }
}

function refreshUI(){
  renderCars();
  updateAnalytics();
  renderGoals();
  renderProItems();
  renderActivity();
  switchWorkspaceTab(workspaceTab || 'goals');
}

/* =========================
   Existing manuscript logic
========================= */
const GOAL = 50000;

const carNames = [
  "Engine",
  "Coach (Open) Car",
  "Observation Car",
  "Dining Car",
  "Coach (Compartment) Car",
  "Sleeper Car",
  "Beverage Car",
  "Tender Engine",
  "Lounge Car",
  "Baggage Car",
  "Double Decker Car"
];

let state = carNames.map(name=>({name,current:0,goal:3000,stage:"Outline"}));
let sessions = [];
let selectedIndex=0;

function renderCars(){
  const container=document.getElementById("carsContainer");
  container.innerHTML="";
  state.forEach((car,i)=>{
    const percent=Math.min(100,Math.floor(car.current/car.goal*100));
    const r=32;
    const c=2*Math.PI*r;
    const o=c-(percent/100)*c;
    const div=document.createElement("div");
    div.className="car";
    if(i===selectedIndex)div.classList.add("active");
    div.onclick=()=>{selectedIndex=i;renderCars();updateAnalytics();}
    div.innerHTML=`
      <svg width="90" height="90" viewBox="0 0 90 90" aria-label="${car.name} progress">
        <circle cx="45" cy="45" r="${r}" stroke="#e3e9ec" stroke-width="6" fill="none"></circle>
        <circle cx="45" cy="45" r="${r}" stroke="var(--accent)" stroke-width="6"
          fill="none" stroke-linecap="round"
          stroke-dasharray="${c}" stroke-dashoffset="${o}"
          transform="rotate(-90 45 45)"></circle>
        <text x="45" y="45" text-anchor="middle" dominant-baseline="middle"
          class="percent-text">${percent}%</text>
      </svg>
      <div>${car.name}</div>
      <span class="stage-label">${car.stage}</span>
    `;
    container.appendChild(div);
  });
  document.getElementById("totalWords").innerText=
    state.reduce((s,c)=>s+c.current,0).toLocaleString();
}

function openModal(){
  const r=document.getElementById("realmInput");
  r.innerHTML="";
  state.forEach((c,i)=>{
    const o=document.createElement("option");
    o.value=i;o.textContent=c.name;
    r.appendChild(o);
  });
  document.getElementById("modal").style.display="flex";
}
function closeModal(){document.getElementById("modal").style.display="none";}

function submitSession(){
  const words=parseInt(document.getElementById("wordsInput").value);
  const realm=parseInt(document.getElementById("realmInput").value);
  const stage=document.getElementById("stageInput").value;
  const location=document.getElementById("locationInput").value;

  if(!words) return;

  state[realm].current+=words;
  state[realm].stage=stage;

  sessions.push({
    words,
    stage,
    location,
    timestamp:new Date().toISOString()
  });

  // Log it
  addActivity({
    type:"Session Update",
    text:`+${words.toLocaleString()} words · ${stage} · ${location}`,
    system:true
  });

  closeModal();
  renderCars();
  updateAnalytics();
  persistAll();
}

function updateAnalytics(){
  const chartCap = 5000;
  const chartStep = 1000;

  function renderFixedYAxis(yAxisEl, gridEl){
    for(let value = chartCap; value >= chartStep; value -= chartStep){
      const label = document.createElement("div");
      label.textContent = `${value/1000}k`;
      yAxisEl.appendChild(label);

      const line = document.createElement("div");
      gridEl.appendChild(line);
    }
  }

  function makeBar(words){
    const bar = document.createElement("div");
    const normalized = Math.min(words, chartCap) / chartCap;
    bar.className = "bar";
    if(words > chartCap) bar.classList.add("over-cap");
    bar.style.height = `${normalized * 100}%`;
    bar.style.opacity = words > 0 ? "0.85" : "0.25";
    bar.title = `${words.toLocaleString()} words`;
    bar.setAttribute("aria-label", `${words.toLocaleString()} words`);
    return bar;
  }

  const valid=sessions.filter(s=>s.stage!=="Outline");

  // Average per session
  const total=valid.reduce((s,v)=>s+v.words,0);
  const avg=valid.length?Math.round(total/valid.length):0;
  document.getElementById("avgSession").innerText=avg.toLocaleString();

  // Top location
  const locMap={};
  valid.forEach(s=>locMap[s.location]=(locMap[s.location]||0)+1);
  let topLoc="—",max=0;
  for(const l in locMap){
    if(locMap[l]>max){max=locMap[l];topLoc=l;}
  }
  document.getElementById("topLocation").innerText=topLoc;

  // Hourly chart
  const hourMap=new Array(24).fill(0);
  valid.forEach(s=>{
    const h=new Date(s.timestamp).getHours();
    hourMap[h]+=s.words;
  });
  const hourly=document.getElementById("hourlyChart");
  const hourlyYAxis = document.getElementById("hourlyYAxis");
  const hourlyGrid = document.getElementById("hourlyGrid");
  const hourlyXAxis = document.getElementById("hourlyXAxis");
  hourly.innerHTML="";
  hourlyYAxis.innerHTML="";
  hourlyGrid.innerHTML="";
  hourlyXAxis.innerHTML="";

  hourly.style.gridTemplateColumns = `repeat(24, 1fr)`;
  hourlyXAxis.style.gridTemplateColumns = `repeat(24, 1fr)`;

  renderFixedYAxis(hourlyYAxis, hourlyGrid);


  // X-axis labels (24 slots, label every 3 hours)
  for(let i=0;i<24;i++){
    const span = document.createElement("span");
  
    if(i % 3 === 0){
      const date = new Date();
      date.setHours(i);
      span.textContent = date.toLocaleTimeString([], {hour:'numeric'});
    } else {
      span.textContent = "";
    }
  
    hourlyXAxis.appendChild(span);
  }

  // Bars 
  hourMap.forEach(v=>{
    hourly.appendChild(makeBar(v));
  });

  const dominant=hourMap.indexOf(Math.max(...hourMap));
  let animal="—";
  if(dominant>=5&&dominant<9)animal="Early Bird";
  else if(dominant>=9&&dominant<12)animal="Hummingbird";
  else if(dominant>=12&&dominant<17)animal="Lion";
  else if(dominant>=21||dominant<2)animal="Night Owl";
  document.getElementById("animalIndicator").innerText=animal;

  // Daily chart (Calendar Month)
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth(); // 0-based
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  const dayMap = new Array(daysInMonth).fill(0);
  
  // Bucket sessions into correct calendar day
  valid.forEach(s=>{
    const d = new Date(s.timestamp);
    if(d.getFullYear() === year && d.getMonth() === month){
      const dayIndex = d.getDate() - 1;
      dayMap[dayIndex] += s.words;
    }
  });

  const daily = document.getElementById("dailyChart");
  const dailyYAxis = document.getElementById("dailyYAxis");
  const dailyGrid = document.getElementById("dailyGrid");
  const dailyXAxis = document.getElementById("dailyXAxis");
  
  daily.innerHTML="";
  dailyYAxis.innerHTML="";
  dailyGrid.innerHTML="";
  dailyXAxis.innerHTML="";

  daily.style.gridTemplateColumns = `repeat(${daysInMonth}, 1fr)`;
  dailyXAxis.style.gridTemplateColumns = `repeat(${daysInMonth}, 1fr)`;
  
  renderFixedYAxis(dailyYAxis, dailyGrid);
  
  // Bars (one per day)
  dayMap.forEach(v=>{
    daily.appendChild(makeBar(v));
  });

  // X-axis labels every 5th day
  for(let i=0;i<daysInMonth;i++){
    const span = document.createElement("span");
  
    const dayNumber = i + 1;
  
    if(
      dayNumber === 1 ||
      dayNumber % 5 === 0 ||
      dayNumber === daysInMonth
    ){
      span.textContent = dayNumber;
    } else {
      span.textContent = "";
    }
  
    dailyXAxis.appendChild(span);
  }

  // Finish estimate (simple)
  const totalAll = state.reduce((s,c)=>s+c.current,0);
  const remaining = Math.max(0, GOAL - totalAll);
  let estimate = "—";
  if(avg > 0){
    const sessionsLeft = Math.ceil(remaining / avg);
    estimate = `${sessionsLeft.toLocaleString()} sessions`;
  }
  document.getElementById("finishEstimate").innerText = estimate;
}

/* =========================
   NEW: persistence + models
========================= */
const LS_KEY = "manuscriptLedger.v2";

let workspaceTab = "goals";

// Goals
let goals = []; // {id, name, type:'words'|'date', targetWords?, targetDate?, notes, active:boolean, createdAt, updatedAt}
let editingGoalId = null;

// Procrastination items
let proItems = []; // {id,title,url,note,createdAt}

// Activity log
let activity = []; // {id, type, text, ts, system:boolean, manual:boolean}

/* =========================
   NEW: activity logging
========================= */
function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function fmtTime(ts){
  const d = new Date(ts);
  return d.toLocaleString([], {year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
}
function escapeHtml(str){
  return (str ?? "").toString()
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/\"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

function addActivity({type, text, system=false, manual=false}){
  const entry = {
    id: uid("log"),
    type,
    text,
    ts: new Date().toISOString(),
    system,
    manual
  };
  activity.unshift(entry);
  renderActivity();
  persistAll();
}

function renderActivity(){
  const log = document.getElementById("activityLog");
  const empty = document.getElementById("activityEmpty");
  if(!activity.length){
    log.innerHTML = "";
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  const isAuthor = isEditMode();
  log.innerHTML = activity.map(e=>{
    const controls = (isAuthor && e.manual) ? `
      <div class="controls">
        <button class="btn-quiet btn-mini" onclick="editManualEntry('${e.id}')">Edit</button>
        <button class="btn-danger btn-mini" onclick="deleteManualEntry('${e.id}')">Delete</button>
      </div>
    ` : "";
    return `
      <article class="log-entry" aria-label="Activity entry">
        <div class="top">
          <div class="type">${escapeHtml(e.type)}</div>
          <time datetime="${escapeHtml(e.ts)}">${escapeHtml(fmtTime(e.ts))}</time>
        </div>
        <div class="text">${escapeHtml(e.text).replace(/\n/g,"<br>")}</div>
        ${controls}
      </article>
    `;
  }).join("");
}

/* =========================
   NEW: tabs + primary action
========================= */
function switchWorkspaceTab(which){
  workspaceTab = which;

  const tabGoals = document.getElementById("tabGoals");
  const tabPro = document.getElementById("tabPro");
  const panelGoals = document.getElementById("panelGoals");
  const panelPro = document.getElementById("panelPro");
  const btn = document.getElementById("primaryActionBtn");

  if(which === "goals"){
    tabGoals.setAttribute("aria-selected","true");
    tabPro.setAttribute("aria-selected","false");
    panelGoals.hidden = false;
    panelPro.hidden = true;
    btn.textContent = "+ Add New";
    btn.onclick = openGoalModal;
  }else{
    tabGoals.setAttribute("aria-selected","false");
    tabPro.setAttribute("aria-selected","true");
    panelGoals.hidden = true;
    panelPro.hidden = false;
    btn.textContent = "+ Add Link/Note";
    btn.onclick = openProModal;
  }
}

/* =========================
   NEW: goals
========================= */
function openGoalModal(goalId=null){
  if(!isEditMode()) return;
  editingGoalId = goalId;
  const m = document.getElementById("goalModal");
  const title = document.getElementById("goalModalTitle");

  // reset fields
  document.getElementById("goalName").value = "";
  document.getElementById("goalType").value = "words";
  document.getElementById("goalTargetWords").value = "";
  document.getElementById("goalTargetDate").value = "";
  document.getElementById("goalNotes").value = "";

  if(goalId){
    const g = goals.find(x=>x.id===goalId);
    if(g){
      title.textContent = "Edit Goal";
      document.getElementById("goalName").value = g.name || "";
      document.getElementById("goalType").value = g.type || "words";
      document.getElementById("goalTargetWords").value = g.targetWords ?? "";
      document.getElementById("goalTargetDate").value = g.targetDate ?? "";
      document.getElementById("goalNotes").value = g.notes || "";
    }
  }else{
    title.textContent = "New Goal";
  }

  syncGoalTypeUI();
  m.style.display = "flex";
}
function closeGoalModal(){
  document.getElementById("goalModal").style.display="none";
  editingGoalId = null;
}
function syncGoalTypeUI(){
  const type = document.getElementById("goalType").value;
  const wf = document.getElementById("goalWordsField");
  const df = document.getElementById("goalDateField");
  if(type === "words"){
    wf.style.display = "";
    df.style.display = "none";
  }else{
    wf.style.display = "none";
    df.style.display = "";
  }
}

function saveGoal(e){
  if(!isEditMode()) return;
  if (e && e.preventDefault) e.preventDefault();
  console.log("EditingGoalId at save:", editingGoalId);
  console.log("SAVE GOAL FIRED");
    
  const name = document.getElementById("goalName").value.trim();
  const type = document.getElementById("goalType").value;
  const notes = document.getElementById("goalNotes").value.trim();
  const rawTargetWords = parseInt(document.getElementById("goalTargetWords").value, 10);
  const targetDate = document.getElementById("goalTargetDate").value;
  const targetWords = Number.isFinite(rawTargetWords) && rawTargetWords > 0 ? rawTargetWords : null;

  if(!name){
    alert("Please give the goal a name.");
    return;
  }
  const now = new Date().toISOString();
  const targetLabel = type === "words"
    ? (targetWords ? `${targetWords.toLocaleString()} words` : "no word target yet")
    : (targetDate ? `by ${targetDate}` : "no date target yet");

  if(editingGoalId && typeof editingGoalId === "string"){
    const idx = goals.findIndex(g=>g.id===editingGoalId);
    if(idx >= 0){
      const prev = goals[idx];
      goals[idx] = {
        ...prev,
        name, type, notes,
        targetWords: type==="words" ? targetWords : null,
        targetDate: type==="date" ? (targetDate || null) : null,
        updatedAt: now
      };
      addActivity({
        type:"Goal Edited",
        text:`${name} (${targetLabel})`,
        system:true
      });
    }
  }else{
    const g = {
      id: uid("goal"),
      name, type, notes,
      targetWords: type==="words" ? targetWords : null,
      targetDate: type==="date" ? (targetDate || null) : null,
      active: goals.length ? false : true, // first goal becomes active by default
      createdAt: now,
      updatedAt: now
    };
    goals.unshift(g);
    console.log("GOALS AFTER PUSH:", goals);

    addActivity({
      type:"Goal Created",
      text:`${name} (${targetLabel})`,
      system:true
    });

    if(g.active){
      addActivity({ type:"Active Goal Set", text:`${g.name}`, system:true });
    }
  }

  closeGoalModal();
  renderGoals();
  persistAll();
  console.info(`[Goals] Saved goal "${name}" (${type}).`);
}

function setActiveGoal(goalId){
  if(!isEditMode()) return;
  const g = goals.find(x=>x.id===goalId);
  if(!g) return;

  // single-active rule: turn off all others
  goals.forEach(x => x.active = (x.id === goalId));
  addActivity({ type:"Active Goal Set", text:`${g.name}`, system:true });

  renderGoals();
  persistAll();
}

function deleteGoal(goalId){
  if(!isEditMode()) return;
  const g = goals.find(x=>x.id===goalId);
  if(!g) return;

  const ok = confirm(`Delete goal: "${g.name}"?`);
  if(!ok) return;

  const wasActive = g.active;
  goals = goals.filter(x=>x.id!==goalId);

  addActivity({ type:"Goal Deleted", text:`${g.name}`, system:true });

  // If active goal deleted, optionally make the next one active
  if(wasActive && goals.length){
    goals[0].active = true;
    addActivity({ type:"Active Goal Set", text:`${goals[0].name}`, system:true });
  }

  renderGoals();
  persistAll();
}

function renderGoals(){
  console.log("GOALS ARRAY:", goals);

  const list = document.getElementById("goalsList");
  const empty = document.getElementById("goalsEmpty");
  const filterSelect = document.getElementById("goalFilter");

  console.log("goalFilter element:", filterSelect);

  const filter = filterSelect ? filterSelect.value : "all";

  const activeGoal = goals.find(g=>g.active);
  document.getElementById("activeGoalPill").textContent =
    `Active: ${activeGoal ? activeGoal.name : "—"}`;

  let visible = goals.slice();
  if(filter === "active"){
    visible = visible.filter(g=>g.active);
  }

  if(!visible.length){
    list.innerHTML = "";
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  const isAuthor = isEditMode();

  list.innerHTML = visible.map(g=>{
    const sub = g.type === "words"
      ? (g.targetWords ? `Target: ${Number(g.targetWords).toLocaleString()} words` : "Target: not set")
      : (g.targetDate ? `Target: ${g.targetDate}` : "Target: not set");
    const noteLine = g.notes ? ` · ${g.notes}` : "";
    const toggle = isAuthor
      ? `<button class="goal-toggle"
          aria-pressed="${g.active ? "true":"false"}"
          onclick="setActiveGoal('${g.id}')">
          ${g.active ? "■" : "□"}
        </button>`
      : `<div aria-hidden="true"></div>`;
    const controls = isAuthor
      ? `<div class="goal-actions">
          <button class="small-link" onclick="openGoalModal('${g.id}')">Edit</button>
          <button class="small-link" onclick="deleteGoal('${g.id}')">Delete</button>
        </div>`
      : "";

    return `
      <div class="goal-item">
        ${toggle}

        <div class="goal-meta">
          <div class="name">${escapeHtml(g.name)}</div>
          <div class="sub">${escapeHtml(sub + noteLine)}</div>
        </div>

        ${controls}
      </div>
    `;
  }).join("");
}

/* =========================
   NEW: Procrastination Station
========================= */
function saveProcrastinationItem(){
  if(!isEditMode()) return;
  const title = document.getElementById("proTitle").value.trim();
  const url = document.getElementById("proUrl").value.trim();
  const note = document.getElementById("proNote").value.trim();

  if(!title && !url && !note){
    alert("Add at least a title, link, or note.");
    return;
  }

  const item = {
    id: uid("pro"),
    title: title || (url ? "Saved link" : "Saved note"),
    url,
    note,
    createdAt: new Date().toISOString()
  };
  proItems.unshift(item);

  // log automatically
  addActivity({
    type:"Procrastination Saved",
    text:`${item.title}${item.url ? " · " + item.url : ""}`,
    system:true
  });

  // reset form
  document.getElementById("proTitle").value="";
  document.getElementById("proUrl").value="";
  document.getElementById("proNote").value="";
  closeProModal();

  renderProItems();
  persistAll();
}

function openProModal(){
  if(!isEditMode()) return;
  document.getElementById("proModal").style.display = "flex";
  document.getElementById("proTitle").focus();
}

function closeProModal(){
  document.getElementById("proModal").style.display = "none";
}

function deleteProItem(id){
  if(!isEditMode()) return;
  const item = proItems.find(x=>x.id===id);
  if(!item) return;
  const ok = confirm(`Delete "${item.title}"?`);
  if(!ok) return;

  proItems = proItems.filter(x=>x.id!==id);
  addActivity({ type:"Procrastination Deleted", text:`${item.title}`, system:true });
  renderProItems();
  persistAll();
}

function renderProItems(){
  const list = document.getElementById("proList");
  const empty = document.getElementById("proEmpty");

  if(!proItems.length){
    list.innerHTML = "";
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  list.innerHTML = proItems.map(p=>{
    const isAuthor = document.body.classList.contains("edit-mode");
    const cardGrid = isAuthor ? "1fr auto" : "1fr";
    const link = p.url
      ? `<div class="sub"><a href="${escapeHtml(p.url)}" target="_blank" rel="noopener noreferrer" style="color:var(--deep)">${escapeHtml(p.url)}</a></div>`
      : "";
    const note = p.note ? `<div class="sub" style="margin-top:6px">${escapeHtml(p.note)}</div>` : "";
    const controls = isAuthor
      ? `<div class="goal-actions"><button class="small-link" onclick="deleteProItem('${p.id}')">Delete</button></div>`
      : "";
    return `
      <div class="goal-item" style="grid-template-columns: ${cardGrid};">
        <div class="goal-meta">
          <div class="name">${escapeHtml(p.title)}</div>
          ${link}
          ${note}
          <div class="sub" style="margin-top:8px; color:var(--muted)">Saved: ${escapeHtml(fmtTime(p.createdAt))}</div>
        </div>
        ${controls}
      </div>
    `;
  }).join("");
}

/* =========================
   NEW: manual notes (editable/deletable only for manual)
========================= */
let editingManualLogId = null;

function openNoteModal(existingId=null){
  if(!isEditMode()) return;
  editingManualLogId = existingId;
  const modal = document.getElementById("noteModal");
  const title = document.getElementById("noteModalTitle");
  const textarea = document.getElementById("noteText");

  if(existingId){
    const entry = activity.find(e=>e.id===existingId);
    if(!entry || !entry.manual) return;
    title.textContent = "Edit Note";
    textarea.value = entry.text || "";
  }else{
    title.textContent = "New Note";
    textarea.value = "";
  }

  modal.style.display = "flex";
  textarea.focus();
}

function closeNoteModal(){
  document.getElementById("noteModal").style.display="none";
  editingManualLogId = null;
}

function saveManualNote(){
  if(!isEditMode()) return;
  const text = document.getElementById("noteText").value.trim();
  if(!text){
    alert("Write something first.");
    return;
  }

  if(editingManualLogId){
    const entry = activity.find(e=>e.id===editingManualLogId);
    if(entry && entry.manual){
      entry.text = text;
      entry.ts = new Date().toISOString();
      // not a system change; still part of log
    }
  }else{
    activity.unshift({
      id: uid("log"),
      type: "Note",
      text,
      ts: new Date().toISOString(),
      system:false,
      manual:true
    });
  }

  closeNoteModal();
  renderActivity();
  persistAll();
}

function editManualEntry(id){
  if(!isEditMode()) return;
  openNoteModal(id);
}
function deleteManualEntry(id){
  if(!isEditMode()) return;
  const entry = activity.find(e=>e.id===id);
  if(!entry || !entry.manual) return;
  const ok = confirm("Delete this note?");
  if(!ok) return;

  activity = activity.filter(e=>e.id!==id);
  renderActivity();
  persistAll();
}

/* =========================
   Persistence
========================= */
function persistAll(){
  hasLocalMutations = true;

  const payload = {
    v: 2,
    state,
    sessions,
    selectedIndex,
    goals,
    proItems,
    activity,
    workspaceTab
  };

  // Local save always
  localStorage.setItem(LS_KEY, JSON.stringify(payload));

  // Cloud save only when author is in edit mode
  if (isEditMode()) {
    fetch(SCRIPT_URL, {
      method: 'POST',
      // Keep this request "simple" for Google Apps Script CORS compatibility.
      // Setting application/json forces a preflight that Apps Script web apps
      // often reject, causing cloud saves to silently fail.
      body: JSON.stringify(payload)
    })
    .then(res => {
      if(!res.ok){
        console.warn(`[Cloud Save] Failed with status ${res.status}.`);
      }else{
        console.info('[Cloud Save] Synced successfully.');
      }
    })
    .catch(()=>console.warn('[Cloud Save] Network error; local copy is still saved.'));
  }else{
    console.info('[Local Save] Saved locally only. Use ?mode=edit to sync to cloud.');
  }
}

// Author-only: wipe everything for testing
function resetEverything(){
  const toggle = document.getElementById('resetToggle');
  if (toggle && !toggle.checked) {
    alert('Flip the toggle first to arm the reset.');
    return;
  }

  const ok = confirm('RESET EVERYTHING to zero? This clears local + cloud data for this ledger.');
  if (!ok) return;

  // Reset core manuscript data
  state = carNames.map(name => ({ name, current: 0, goal: 3000, stage: 'Outline' }));
  sessions = [];
  selectedIndex = 0;

  // Reset workspace data
  goals = [];
  proItems = [];
  activity = [];
  workspaceTab = 'goals';

  // Clear local storage
  localStorage.removeItem(LS_KEY);

  // Reset UI + save (cloud save only in edit-mode)
  refreshUI();
  persistAll();

  // Disarm toggle + disable button again
  if (toggle) {
    toggle.checked = false;
    const btn = document.getElementById('resetBtn');
    if (btn) btn.disabled = true;
  }
}

function loadAll(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);

    if(Array.isArray(data.state)) state = data.state;
    if(Array.isArray(data.sessions)) sessions = data.sessions;
    if(Number.isFinite(data.selectedIndex)) selectedIndex = data.selectedIndex;

    if(Array.isArray(data.goals)) goals = data.goals;
    if(Array.isArray(data.proItems)) proItems = data.proItems;
    if(Array.isArray(data.activity)) activity = data.activity;
    if(typeof data.workspaceTab === "string") workspaceTab = data.workspaceTab;
  }catch(e){
    // ignore
  }
}

/* =========================
   Boot
========================= */
// Bind goal save button safely (Google Sites compatible)
document.addEventListener("DOMContentLoaded", function(){
  const btn = document.getElementById("goalSaveBtn");
  if(btn){
    btn.addEventListener("click", () => saveGoal());
  }
});
  
(async function boot(){
  await loadFromCloud();   // ALWAYS pull fresh cloud

  // Only use local snapshot in edit mode
  if (isEditMode()) {
    loadAll();
  }

  refreshUI();

  // Enforce single active goal
  const active = goals.filter(g => g.active);
  if (active.length > 1) {
    const keep = active[0].id;
    goals.forEach(g => g.active = (g.id === keep));
    persistAll();
    renderGoals();
  }
})();
</script>

</body>
</html>
